<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Community Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="/css/admin/dashboard.css">
</head>
<body>
    <!-- Sidebar -->
     <%- include('../partials/sidebarAdmin') %>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="menu-toggle" id="mobileMenuToggle">
                    <span class="material-symbols-rounded">menu</span>
                </button>
                <div>
                    <h1>Dashboard Overview</h1>
                    <div class="header-subtitle">Welcome back, Admin! Here's what's happening across all communities.</div>
                </div>
            </div>
            
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card communities">
                <div class="kpi-header">
                    <div class="kpi-icon">
                        <span class="material-symbols-rounded">apartment</span>
                    </div>
                    <div class="kpi-title">Total Communities</div>
                </div>
                <div class="kpi-value">42</div>
                <div class="kpi-change positive">
                    <span class="material-symbols-rounded">trending_up</span>
                    +3 this month
                </div>
            </div>

            <div class="kpi-card residents">
                <div class="kpi-header">
                    <div class="kpi-icon">
                        <span class="material-symbols-rounded">groups</span>
                    </div>
                    <div class="kpi-title">Total Residents</div>
                </div>
                <div class="kpi-value">1,847</div>
                <div class="kpi-change positive">
                    <span class="material-symbols-rounded">trending_up</span>
                    +12.5% vs last month
                </div>
            </div>

            <div class="kpi-card applications">
                <div class="kpi-header">
                    <div class="kpi-icon">
                        <span class="material-symbols-rounded">pending_actions</span>
                    </div>
                    <div class="kpi-title">Pending Applications</div>
                </div>
                <div class="kpi-value">156</div>
                <div class="kpi-change negative">
                    <span class="material-symbols-rounded">trending_down</span>
                    -12 this week
                </div>
            </div>

            <div class="kpi-card revenue">
                <div class="kpi-header">
                    <div class="kpi-icon">
                        <span class="material-symbols-rounded">account_balance_wallet</span>
                    </div>
                    <div class="kpi-title">Monthly Revenue</div>
                </div>
                <div class="kpi-value">₹24.8L</div>
                <div class="kpi-change positive">
                    <span class="material-symbols-rounded">trending_up</span>
                    +18% vs last month
                </div>
            </div>

          
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Portfolio Growth & Revenue</div>
                    <div class="chart-filter">
                        <button class="filter-btn active">6M</button>
                        <button class="filter-btn">1Y</button>
                        <button class="filter-btn">All</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Applications Overview</div>
                </div>
                <div class="applications-overview">
                    <div class="applications-summary">
                        <div class="summary-item">
                            <div class="summary-value">324</div>
                            <div class="summary-label">This Month</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">156</div>
                            <div class="summary-label">Pending</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">142</div>
                            <div class="summary-label">Approved</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">26</div>
                            <div class="summary-label">Rejected</div>
                        </div>
                    </div>
                    
                    <div class="applications-charts">
                        <div class="trend-chart-container">
                            <canvas id="applicationsTrendChart"></canvas>
                        </div>
                        <div class="status-chart-container">
                            <div class="doughnut-wrapper">
                                <canvas id="applicationsStatusChart"></canvas>
                            </div>
                            <div class="status-summary">
                                <div class="status-item">
                                    <div class="status-label">
                                        <div class="status-color" style="background: #10b981;"></div>
                                        Approved
                                    </div>
                                    <div class="status-value">142</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">
                                        <div class="status-color" style="background: #f59e0b;"></div>
                                        Pending
                                    </div>
                                    <div class="status-value">156</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">
                                        <div class="status-color" style="background: #ef4444;"></div>
                                        Rejected
                                    </div>
                                    <div class="status-value">26</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      
    </div>

   <script>// Configuration
const API_BASE_URL = window.location.origin + '/admin/api';

// Global variables for charts
let growthChart;
let applicationsStatusChart;

// DOM elements
const elements = {
    // KPI Values
    totalCommunities: document.querySelector('.kpi-card.communities .kpi-value'),
    totalResidents: document.querySelector('.kpi-card.residents .kpi-value'),
    pendingApplications: document.querySelector('.kpi-card.applications .kpi-value'),
    monthlyRevenue: document.querySelector('.kpi-card.revenue .kpi-value'),
    activeManagers: document.querySelector('.kpi-card.managers .kpi-value'),
    
    // KPI Changes
    communitiesChange: document.querySelector('.kpi-card.communities .kpi-change'),
    residentsChange: document.querySelector('.kpi-card.residents .kpi-change'),
    applicationsChange: document.querySelector('.kpi-card.applications .kpi-change'),
    revenueChange: document.querySelector('.kpi-card.revenue .kpi-change'),
    managersChange: document.querySelector('.kpi-card.managers .kpi-change'),
    
    // Application Summary
    monthlyApplications: document.querySelectorAll('.summary-item .summary-value')[0],
    pendingCount: document.querySelectorAll('.summary-item .summary-value')[1],
    approvedCount: document.querySelectorAll('.summary-item .summary-value')[2],
    rejectedCount: document.querySelectorAll('.summary-item .summary-value')[3],
 
};

// Utility functions
function formatCurrency(value) {
    return `₹${value}`;
}

function formatChange(change, type, period) {
    const prefix = change > 0 ? '+' : '';
    const suffix = type.includes('percentage') ? '%' : '';
    const icon = change > 0 ? 'trending_up' : 'trending_down';
    const className = change > 0 ? 'positive' : 'negative';
    
    return {
        text: `${prefix}${change}${suffix} ${type.includes('percentage') ? 'vs' : 'this'} ${period}`,
        icon: icon,
        className: className
    };
}

function showLoading() {
    document.body.classList.add('loading');
}

function hideLoading() {
    document.body.classList.remove('loading');
}

function showError(message) {
    console.error('Dashboard Error:', message);
   
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = `Error: ${message}`;
    errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ef4444;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 5000);
}

// API functions
async function fetchDashboardData() {
    try {
        const response = await fetch(`${API_BASE_URL}/dashboard`);
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const result = await response.json();
        return result.data;
    } catch (error) {
        console.error('Failed to fetch dashboard data:', error);
        throw error;
    }
}

async function fetchChartData(period = '6M') {
    try {
        const response = await fetch(`${API_BASE_URL}/dashboard/charts?period=${period}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const result = await response.json();
        return result.data;
    } catch (error) {
        console.error('Failed to fetch chart data:', error);
        throw error;
    }
}


// Update functions
function updateKPIs(data) {
    const { kpis, trends={} } = data;
    
    // Update values
    if (elements.totalCommunities) elements.totalCommunities.textContent = kpis.totalCommunities;
    if (elements.totalResidents) elements.totalResidents.textContent = kpis.totalResidents.toLocaleString();
    if (elements.pendingApplications) elements.pendingApplications.textContent = kpis.pendingApplications;
    if (elements.monthlyRevenue) elements.monthlyRevenue.textContent = formatCurrency(kpis.monthlyRevenue);
    if (elements.activeManagers) elements.activeManagers.textContent = kpis.activeManagers;
    
    // Update changes
    const changeElements = [
        { element: elements.communitiesChange, trend: trends.communities },
        { element: elements.residentsChange, trend: trends.residents },
        { element: elements.applicationsChange, trend: trends.applications },
        { element: elements.revenueChange, trend: trends.revenue },
        { element: elements.managersChange, trend: trends.managers }
    ];
    
    changeElements.forEach(({ element, trend }) => {
        if (element && trend) {
            const changeInfo = formatChange(trend.change, trend.type, trend.period);
            const icon = element.querySelector('.material-symbols-rounded');
            const textNode = element.childNodes[element.childNodes.length - 1];
            
            if (icon) icon.textContent = changeInfo.icon;
            if (textNode) textNode.textContent = changeInfo.text;
            
            element.className = `kpi-change ${changeInfo.className}`;
        }
    });
}

function updateApplicationsSummary(data) {
    const { applicationsStatus } = data;
    const total = applicationsStatus.approved + applicationsStatus.pending + applicationsStatus.rejected;
    
    if (elements.monthlyApplications) elements.monthlyApplications.textContent = total;
    if (elements.pendingCount) elements.pendingCount.textContent = applicationsStatus.pending;
    if (elements.approvedCount) elements.approvedCount.textContent = applicationsStatus.approved;
    if (elements.rejectedCount) elements.rejectedCount.textContent = applicationsStatus.rejected;
    
    // Update status summary in doughnut chart section
    const statusItems = document.querySelectorAll('.status-item .status-value');
    if (statusItems.length >= 3) {
        statusItems[0].textContent = applicationsStatus.approved;
        statusItems[1].textContent = applicationsStatus.pending;
        statusItems[2].textContent = applicationsStatus.rejected;
    }
}


function updateCharts(data) {
    updateGrowthChart(data.growthChart);
    updateApplicationsStatusChart(data.applicationsStatus);
}

function updateGrowthChart(data) {
  if (!data || !data.growthChart) return;
  const { labels = [], communities = [], revenue = [] } = data.growthChart;
    const ctx = document.getElementById('growthChart');
    if (!ctx) return;
    
    // Destroy existing chart
    if (growthChart) {
        growthChart.destroy();
    }
    
    growthChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'New Communities',
                data: data.communities,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }, {
                label: 'Revenue (₹L)',
                data: data.revenue,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(21, 26, 45, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            elements: {
                point: {
                    radius: 6,
                    hoverRadius: 8
                }
            }
        }
    });
}

function updateApplicationsStatusChart(data) {
    const ctx = document.getElementById('applicationsStatusChart');
    if (!ctx) return;
    
    // Destroy existing chart
    if (applicationsStatusChart) {
        applicationsStatusChart.destroy();
    }
    
    applicationsStatusChart = new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Approved', 'Pending', 'Rejected'],
            datasets: [{
                data: [data.approved, data.pending, data.rejected],
                backgroundColor: [
                    '#10b981',
                    '#f59e0b',
                    '#ef4444'
                ],
                borderWidth: 0,
                cutout: '65%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Event handlers
function handleChartFilterClick(period) {
    showLoading();
    fetchChartData(period)
        .then(data => {
            updateCharts(data);
            hideLoading();
        })
        .catch(error => {
            hideLoading();
            showError('Failed to update charts');
        });
}

// Initialize dashboard
async function initializeDashboard() {
    showLoading();
    
    try {
        // Fetch all data in parallel
        const [dashboardData] = await Promise.all([
            fetchDashboardData(),
       
        ]);
        
        // Update UI
        updateKPIs(dashboardData);
        updateApplicationsSummary(dashboardData.chartData);
        updateCharts(dashboardData.chartData);
         
        console.log('Dashboard initialized successfully');
        
    } catch (error) {
        showError('Failed to load dashboard data');
        console.error('Dashboard initialization error:', error);
    } finally {
        hideLoading();
    }
}


// DOM Content Loaded
document.addEventListener('DOMContentLoaded', () => {
    // Initialize dashboard
    initializeDashboard();
    
    // Start auto-refresh
    startAutoRefresh();
    
    // Sidebar functionality
    const sidebar = document.getElementById('sidebar');
    const sidebarToggler = document.getElementById('sidebarToggler');
    const menuToggler = document.getElementById('menuToggler');
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');

    // Desktop sidebar toggle
    if (sidebarToggler) {
        sidebarToggler.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });
    }

    // Mobile menu toggle
    const mobileTogglers = [menuToggler, mobileMenuToggle].filter(Boolean);
    mobileTogglers.forEach(toggler => {
        toggler.addEventListener('click', () => {
            sidebar.classList.toggle('menu-active');
            const icon = toggler.querySelector('span');
            if (icon) {
                icon.textContent = sidebar.classList.contains('menu-active') ? 'close' : 'menu';
            }
        });
    });

    // Close mobile menu on outside click
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 1024 && 
            !sidebar.contains(e.target) && 
            !mobileTogglers.some(toggler => toggler && toggler.contains(e.target))) {
            sidebar.classList.remove('menu-active');
            mobileTogglers.forEach(toggler => {
                const icon = toggler && toggler.querySelector('span');
                if (icon) icon.textContent = 'menu';
            });
        }
    });

    // Chart filter buttons
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            handleChartFilterClick(this.textContent);
        });
    });

    // Responsive handling
    window.addEventListener("resize", () => {
        if (window.innerWidth >= 1024) {
            sidebar.classList.remove("menu-active");
            mobileTogglers.forEach(toggler => {
                const icon = toggler && toggler.querySelector('span');
                if (icon) icon.textContent = 'menu';
            });
        }
    });

    // Add animation to KPI cards
    const kpiCards = document.querySelectorAll('.kpi-card');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    });

    kpiCards.forEach((card) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'all 0.6s ease';
        observer.observe(card);
    });
});

// Loading styles (add to CSS)
const loadingStyles = `
    .loading {
        cursor: wait;
    }
    
    .loading .kpi-value,
    .loading .chart-container {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .error-message {
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
`;

// Inject loading styles
const styleSheet = document.createElement('style');
styleSheet.textContent = loadingStyles;
document.head.appendChild(styleSheet);

// Export functions for external use
window.dashboardAPI = {
    refresh: initializeDashboard,
    updateCharts: handleChartFilterClick,
    fetchDashboardData,
   
};</script>
</body>
</html>